#!/usr/bin/env perl

use strict;
use diagnostics;
use warnings;

use CPrAN;
use CPrAN::Plugin;
use WWW::GitLab::v3;
use Capture::Tiny ':all';
use Try::Tiny;
use Carp;

use POSIX;
print strftime("%Y-%m-%dT%T%z", localtime) . ' ';

my $app = CPrAN->new;
my $api = WWW::GitLab::v3->new(
  url   => $app->api_url(),
  token => $ENV{'CPRAN_PUSHER_TOKEN'},
);

my ($pid, $sid);
try {
  $pid = $api->projects( { search => 'plugin_cpran' } )->[0]->{id};
  my $snippets = $api->snippets($pid);
  foreach (@{$snippets}) {
    $sid = $_->{id} if $_->{file_name} eq 'cpran.list';
  }
}
catch {
  print "Unable to find package list id\n";
  exit 1;
};

my $cmd = CPrAN::Command::update->new({});

my ($stdout, $stderr) = capture {
  $app->execute_command($cmd, {
    virtual => 1,
    raw     => 1,
    print   => 1,
  }, '');
};

if ($stderr ne '') {
  print "Errors found during update\n";
  exit 1;
}

try {
  $api->edit_snippet(
    $pid, $sid, {
      code => $stdout
    }
  );
}
catch {
  print "Could not upload package list\n";
  exit 1;
};

print "Success\n";

